# 安裝

<br>

## 安裝基本環境

1. 更新

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

<br>

2. 遇到提示移除不必要套件就跟著做。

    ```bash
    sudo apt autoremove
    ```

<br>

3. 安裝多個依賴套件，主要用來搭建 LAMP(Linux, Apache, MySQL/MariaDB, PHP) 環境。

    ```bash
    sudo apt install apache2 mariadb-server php php-mysql php-gd php-curl php-xml php-zip php-intl php-mbstring php-json php-imagick libapache2-mod-php
    ```

<br>

## 將相關套件設置為開啟啟動

1. 開機啟動服務：`apache2` 。

    ```bash
    sudo systemctl enable apache2
    ```

<br>

2. 開機啟動服務：`mariadb` 。

    ```bash
    sudo systemctl enable mariadb
    ```

<br>

3. 立即啟動服務

    ```bash
    sudo systemctl start apache2 && sudo systemctl start mariadb
    ```

<br>

4. 設定資料庫：這個步驟跟 `MySQL` 的章節是一樣的，這裡簡單帶過，以下五次 `NO` + 一次 `YES` 。

    ```bash
    sudo mysql_secure_installation
    ```

<br>

5. 預設沒有密碼，直接 `ENTER` 即可。

    ![](images/img_01.png)

<br>

6. NO

    ![](images/img_02.png)

<br>

7. NO

    ![](images/img_03.png)

<br>

8. NO

    ![](images/img_04.png)

<br>

9. NO

    ![](images/img_05.png)

<br>

10. NO

    ![](images/img_06.png)

<br>

11. YES

    ![](images/img_07.png)

<br>

12. 然後會啟動資料庫。

    ![](images/img_08.png)

<br>

13. 登入資料庫(預設沒密碼)。

    ```bash
    sudo mysql -u root -p
    ```

    ![](images/img_09.png)

<br>

14. 建立資料庫以及資料庫使用者。

    ```bash
    CREATE DATABASE nextcloud;
    ```

<br>

15. 賦予權限。

    ```bash
    GRANT ALL PRIVILEGES ON nextcloud.* TO 'sam6238'@'%' IDENTIFIED BY 'sam112233';
    ```

<br>

16. 刷新權限。

    ```bash
    FLUSH PRIVILEGES;
    ```

<br>

17. 退出資料庫系統。

    ```bash
    EXIT;
    ```

    ![](images/img_10.png)

<br>

## 安裝 Nextcloud

1. 切換到要安裝 Nextcloud 的資料夾。

    ```bash
    cd /var/www/html
    ```

<br>

2. 下載 Nextcloud。

    ```bash
    sudo wget https://download.nextcloud.com/server/releases/latest.tar.bz2
    ```

    ![](images/img_11.png)

<br>

3. 解壓縮，需要一點時間，畫面沒有變化，耐心等待。
    
    ```bash
    sudo tar -xjf latest.tar.bz2
    ```

    ![](images/img_38.png)

<br>

3. 設定權限，需要一點時間。

    ```bash
    sudo chown -R www-data:www-data /var/www/html/nextcloud && sudo find /var/www/html/nextcloud/ -type d -exec chmod 750 {} \; && sudo find /var/www/html/nextcloud/ -type f -exec chmod 640 {} \;
    ```

<br>

4. 建立 Nextcloud 設定檔 `nextcloud.conf` 。

    ```bash
    sudo nano /etc/apache2/sites-available/nextcloud.conf
    ```

<br>

5. 貼上以下內容，儲存退出。

    ```ini
    Alias /nextcloud "/var/www/html/nextcloud"

    <Directory /var/www/html/nextcloud>
    Require all granted
    AllowOverride All
    Options FollowSymLinks MultiViews

    <IfModule mod_dav.c>
        Dav off
    </IfModule>

    </Directory>
    ```

<br>

6. 啟用站點。

    ```bash
    sudo a2ensite nextcloud.conf
    ```

<br>

7. 出現提示訊息說要載入 `apache2` ，但現在還不需要啟動，所以不用執行 `systemctl reload apache2` 。

    ![](images/img_12.png)

<br>

8. 啟動必要模組。

    ```bash
    sudo a2enmod rewrite headers env dir mime
    ```
    
    ![](images/img_13.png)

<br>

9. 查詢 `nginx` 服務狀態。

    ```bash
    sudo systemctl status nginx
    ```

    ![](images/img_14.png)

<br>

10. 假如 `nginx` 是啟用狀態，要先停用。

    ```bash
    sudo systemctl stop nginx
    ```

<br>

11. 查詢 `apache2` 服務狀態，確認是 `active` 。

    ```bash
    sudo systemctl status apache2
    ```

    ![](images/img_15.png)

<br>

12. 如需前一個步驟顯示尚未啟用 `apache2` ，則需立即啟用並設定為開機啟動。

    ```bash
    sudo systemctl start apache2 && sudo systemctl enable apache2
    ```

<br>

13. 執行以下指令確保模組已經啟用。

    ```bash
    sudo a2enmod rewrite
    ```

    ![](images/img_17.png)

<br>

14. 重啟 Apache

    ```bash
    sudo systemctl restart apache2
    ```

<br>

15. 安裝套件 `software-properties-common`。

    ```bash
    sudo apt install -y software-properties-common
    ```

    ![](images/img_18.png)

<br>

16. (跳過) 在系統中添加一個 `ondrej/php` 的個人軟體包存檔（Personal Package Archive，簡稱PPA），主要目的是獲得更新的PHP版本，添加這個PPA後就可安裝或更新到這個 PPA 提供的 PHP 版本。。

    ```bash
    sudo add-apt-repository ppa:ondrej/php
    ```

<br>

17. (跳過) 會顯示提醒按下 `ENTER` 繼續。

    ![](images/img_19.png)

<br>

18. (跳過) 出現關於棄用的警告，這在後續繼續安裝可能會出錯。

    ![](images/img_20.png)

<br>

## 排除問題

1. 執行更新指令，確實出現一些錯誤。

    ```bsh
    sudo apt update
    ```

    ![](images/img_22.png)

<br>

2. (跳過) 切換到套件列表管理目錄。

    ```bash
    cd /etc/apt/sources.list.d/
    ```

<br>

3. (跳過) 查看有哪些列表，假如有切換目錄，僅需 `ls` 。

    ```bash
    ls
    ```

    ![](images/img_23.png)

<br>

4. (跳過) 編輯兩個列表，將導致錯誤的來源註解。

    ```bash
    sudo nano ondrej-ubuntu-php-noble.list
    sudo nano ondrej-ubuntu-php-noble.list.save
    ```

    ![](images/img_24.png)

<br>

5. 安裝兩個套件

    ```bash
    sudo apt install ca-certificates apt-transport-https
    ```

    ![](images/img_25.png)

<br>

6. 下載公鑰。

    ```bash
    wget -q https://packages.sury.org/php/apt.gpg -O- | sudo tee /etc/apt/trusted.gpg.d/php.gpg
    ```

<br>

7. 出現可怕的一堆亂碼。

    ![](images/img_26.png)

<br>

8. 先用 gpg 命令來列出密鑰並驗證密鑰是否正確下載。

    ```bash
    sudo gpg --show-keys /etc/apt/trusted.gpg.d/php.gpg
    ```

<br>

9. 既然正確下載了，就不予理會了。

    ![](images/img_27.png)

<br>

10. 添加資源列表。

    ```bash
    echo "deb https://packages.sury.org/php/ bullseye main" | sudo tee /etc/apt/sources.list.d/php.list
    ```

<br>

11. 進行更新。

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

<br>

12. 完成上面步驟，可以安裝 PHP8.1 等套件。

    ```bash
    sudo apt install php8.1 php8.1-common php8.1-cli php8.1-bcmath php8.1-fpm php8.1-mbstring php8.1-xml php8.1-curl php8.1-gd php8.1-mysql php8.1-pgsql php8.1-sqlite3 php8.1-zip php8.1-readline php8.1-opcache
    ```

<br>

13. 安裝好會顯示以下訊息。

    ![](images/img_28.png)

<br>

14. 設定預設版本，在 `2023/12/06` 時又更新到 `8.3` 了。

    ```bash
    sudo update-alternatives --config php
    ```

    ![](images/img_39.png)

<br>

15. 不要使用 8.3，因為當前版本不適配。

    ![](images/img_41.png)

<br>

16. 假如不想切換，也可以在下指令時指定。

    ```bash
    sudo update-alternatives --set php /usr/bin/php8.1
    ```

<br>

17. 查看目前連結的版本。

    ```bash
    sudo update-alternatives --display php
    ```

    ![](images/img_40.png)

<br>

18. 確認已經啟用版本。

    ```bash
    sudo apache2ctl -M | grep php
    ```

    ![](images/img_31.png)

<br>

19. 關於 `AH00558`：表示 Apache 伺服器無法可靠地確定伺服器的完全合格域名（FQDN），Apache 嘗試自動檢測域名，但未能確定，因此它回退到使用本地回路地址 `127.0.1.1`，接下來依照訊息的建議進行設置。

    ![](images/img_32.png)

<br>

20. 安裝。

    ```bash
    sudo apt install libapache2-mod-php8.1
    ```

<br>

21. 也可以直接安裝 8.3。

    ```bash
    sudo apt install libapache2-mod-php8.3
    ```

<br>

22. 停用舊版 7.4、啟用新版 8.1。

    ```bash
    sudo a2dismod php7.4 && sudo a2enmod php8.1 && sudo systemctl restart apache2
    ```

<br>

23. 假如安裝了 8.3，可以啟用 8.3。

    ```bash
    sudo a2dismod php7.4 && sudo a2enmod php8.3 && sudo systemctl restart apache2
    ```

<br>

24. 再查看一次啟用的版本，確實已經切換。

    ```bash
    sudo apache2ctl -M | grep php
    ```

    ![](images/img_33.png)

<br>

25. 重新啟動。

    ```bash
    sudo reboot
    ```

<br>

## 重新開機後

1. 先連線樹莓派。

<br>

2. 切換目錄。

    ```bash
    cd  /var/www/html
    ```

<br>

3. 授權，授權後還沒完成喔。

    ```bash
    sudo chown -R sam6238:sam6238 /var/www/html/nextcloud
    ```

<br>

4. 這時候訪問，還是沒權限的。

    ![](images/img_34.png)

<br>

5. 確保 `.htaccess` 文件存在。

    ```bash
    ls -la /var/www/html/nextcloud | grep .htaccess
    ```

    ![](images/img_35.png)

<br>

6. 確保 `.htaccess` 文件的權限為 `644` 。

    ```bash
    sudo chmod 644 /var/www/html/nextcloud/.htaccess
    ```

<br>

7. 確保目錄 `/var/www/html/nextcloud` 和其子目錄的權限至少為 `755` 。

    ```bash
    sudo chmod -R 755 /var/www/html/nextcloud
    ```

<br>

8. 確保 `www-data`（或 Web 伺服器的用戶）是 `/var/www/html/nextcloud` 和其子目錄的擁有者。

    ```bash
    sudo chown -R www-data:www-data /var/www/html/nextcloud
    ```

<br>

9. 訪問 `<樹莓派 IP>/nextcloud`，成功連線 `Nextcloud`。

    ![](images/img_36.png)

<br>

## 連線以後

_請特別留意這個步驟_

<br>

1. 安裝

    ![](images/img_37.png)

<br>

## 其他指令

2. 檢查端口。

    ```bash
    sudo netstat -tuln | grep ':80'
    ```

<br>

3. 假如有安裝 `ufw` 可查看防火牆。

    ```bash
    sudo ufw status
    ```

<br>

4. 查看 Apache 日誌。

    ```bash
    sudo cat /var/log/apache2/error.log
    ```

<br>

5. 確認 Apache 的設定語法是否正確。

    ```bash
    sudo apache2ctl configtest
    ```

    ![](images/img_16.png)


<br>


---

_END_


