# 簡易的自訂服務範例

_使用 Python 腳本，在開機後發送 Line 通知，另外，使用 Bash 腳本會相對簡單，可參考後續小節說明。_

<br>

## 取得 LineNotify Token

1. 關於取得 Token 的部分暫時略過，請自行操作，務必確保妥善保存 Token。

<br>

2. 建立環境變數文件 `/etc/environment`。

    ```bash
    sudo nano /etc/environment
    ```

<br>

3. 編輯環境變數文件，並添加 LINE Notify Token；完成後保存並退出 (`Ctrl+X` 然後按 `Y` 保存)。

    ```bash
    LINE_NOTIFY_TOKEN=<輸入 LINE_NOTIFY_TOKEN>
    ```

<br>

## 建立 Python 腳本

1. 在家目錄的 `文件 Documents` 建立腳本 `send_line_notify.py`。

    ```bash
    cd ~/Documents && mkdir MyNotify && cd MyNotify
    ```

<br>

2. 編輯腳本發送 Line 通知。

    ```python
    import requests
    import os

    def send_line_notify(message, token):
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/x-www-form-urlencoded"
        }
        data = {"message": message}
        url = "https://notify-api.line.me/api/notify"
        response = requests.post(url, headers=headers, data=data)
        return response.status_code

    if __name__ == "__main__":
        token = os.getenv("LINE_NOTIFY_TOKEN")
        message = "\n樹莓派已經成功開機。"
        status = send_line_notify(message, token)
        if status == 200:
            print("Line 通知發送成功。")
        else:
            print("Line 通知發送失敗。")
    ```

<br>

## 權限設定

1. 確保 `send_line_notify.py` 有執行權限。

    ```bash
    chmod +x ~/Documents/send_line_notify.py
    ```

<br>

## 服務文件

1. 建立一個開機時運行的服務文件 `send_line_notify.service`。

    ```bash
    sudo nano /etc/systemd/system/send_line_notify.service
    ```

<br>

2. 編輯服務文件，其中會使用樹莓派系統預裝的 `python3` 運行自訂並存放在 `Documents` 的腳本 `send_line_notify.py`；完成後同樣保存並退出。

    ```ini
    [Unit]
    Description=Send Line Notify on boot
    After=network.target

    [Service]
    ExecStart=/usr/bin/python3 ~/Documents/send_line_notify.py
    Restart=on-failure
    User=pi
    EnvironmentFile=/etc/environment

    [Install]
    WantedBy=multi-user.target
    ```

<br>

3. 重新加載 systemd 配置。

    ```bash
    sudo systemctl daemon-reload
    ```

<br>

4. 設置為開機啟動並立即啟動服務。

    ```bash
    sudo systemctl enable send_line_notify.service && sudo systemctl start send_line_notify.service
    ```

<br>

5. 確認服務狀態。

    ```bash
    sudo systemctl status send_line_notify.service
    ```

<br>

6. 重啟系統並確認 Line 對話中是否收到開機成功的通知。

    ```bash
    sudo reboot
    ```

<br>

___

_END_

