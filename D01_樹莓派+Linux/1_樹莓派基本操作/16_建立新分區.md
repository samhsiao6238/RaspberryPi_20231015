## 添加並啟用新分區

_在樹莓派系統碟上建立多個分區_

<br>

## 開始

1. 在現有樹莓派系統上插入燒錄好樹莓派系統的外接裝置，透過指令查詢當前分區。

    ```bash
    lsblk
    ```
    _輸出_
    ```bash
    sam6238@raspi-2024-01:~ $ lsblk
    NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
    sda           8:0    0 476.9G  0 disk 
    ├─sda1        8:1    0   512M  0 part /media/sam6238/bootfs
    └─sda2        8:2    0     5G  0 part /media/sam6238/rootfs
    mmcblk0     179:0    0  58.3G  0 disk 
    ├─mmcblk0p1 179:1    0   512M  0 part /boot/firmware
    └─mmcblk0p2 179:2    0  57.7G  0 part /
    ```

<br>

2. 在樹莓派運行 `gparted`，並切換到新插入的儲存裝置上，假如出現錯誤可先進行排除。

    ```bash
    sudo gparted
    ```

    ![](images/img_137.png)

<br>

3. 可先嘗試安裝欠缺的套件再繼續。

    ```bash
    sudo apt install dosfstools mtools
    ```

<br>

4. 先拓展現有系統資料分區到 100G，緊接著在 `未配置` 點擊右鍵後選取 `新增`。

    ![](images/img_136.png)

<br>

5. 再建立一個 100G 的分區然後打勾，特別注意，這個分區的大小並不重要，因為在前一小節操作中已知，樹莓派會將剩餘空間全部指派給這個最後建立的分區。

    ![](images/img_138.png)

<br>

6. 格式化為 `ext4`，同樣再打勾。

    ![](images/img_139.png)

<br>

## 查看 

1. 查看磁碟資訊。

    ```bash
    lsblk
    ```

    _結果_

    ```bash
    NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
    sda           8:0    0 476.9G  0 disk 
    ├─sda1        8:1    0   512M  0 part /media/sam6238/bootfs
    ├─sda2        8:2    0  97.7G  0 part /media/sam6238/rootfs
    └─sda3        8:3    0 281.1G  0 part 
    mmcblk0     179:0    0  58.3G  0 disk 
    ├─mmcblk0p1 179:1    0   512M  0 part /boot/firmware
    └─mmcblk0p2 179:2    0  57.7G  0 part /
    ```

<br>

2. 查詢已掛載分區。

    ```bash
    df -h
    ```

    _結果_

    ```bash
    檔案系統        容量  已用  可用 已用% 掛載點
    udev            3.8G     0  3.8G    0% /dev
    tmpfs           805M  6.0M  799M    1% /run
    /dev/mmcblk0p2   57G  5.8G   49G   11% /
    tmpfs           4.0G  352K  4.0G    1% /dev/shm
    tmpfs           5.0M   48K  5.0M    1% /run/lock
    /dev/mmcblk0p1  510M   76M  435M   15% /boot/firmware
    tmpfs           805M  160K  805M    1% /run/user/1000
    /dev/sda1       510M   75M  436M   15% /media/sam6238/bootfs
    /dev/sda2        97G  4.2G   88G    5% /media/sam6238/rootfs
    ```

3. 接著關機，然後拔出 SD 卡，僅保留外接儲存裝置。

    ```bash
    sudo shutdown now
    ```

<br>

## 再次查看

_使用外接儲存裝置進行啟動_

<br>

1. 查詢，發現樹莓派系統自動將為分配空間全部配置給第三個分區，並且已經自動掛載。

    ```bahs
    lsblk
    ```

    _輸出_

    ```bash
    NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
    sda      8:0    0 476.9G  0 disk 
    ├─sda1   8:1    0   512M  0 part /boot/firmware
    ├─sda2   8:2    0  97.7G  0 part /
    └─sda3   8:3    0 281.1G  0 part /media/sam6238/276422b4-0136-46bb-a4db-e17d2f0ae8f8
    ```

<br>

2. 修改掛載點名稱，首先，卸載該分區。

    ```bash
    sudo umount /media/sam6238/276422b4-0136-46bb-a4db-e17d2f0ae8f8
    ```

<br>

3. 先確認 `PARTUUID` 是 `343dcec1-03`。

    ```bash
    sudo blkid
    ```

    _結果_

    ```bash
    /dev/sda2: LABEL="rootfs" UUID="fc7a1f9e-4967-4f41-a1f5-1b5927e6c5f9" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="343dcec1-02"
    /dev/sda3: LABEL="data" UUID="276422b4-0136-46bb-a4db-e17d2f0ae8f8" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="343dcec1-03"
    /dev/sda1: LABEL_FATBOOT="bootfs" LABEL="bootfs" UUID="50C8-AEAE" BLOCK_SIZE="512" TYPE="vfat" PARTUUID="343dcec1-01"
    ```

<br>

4. 使用 e2label 命令來更改分區的標籤。例如，如果你想將標籤更改為 data。

    ```bash
    sudo e2label /dev/sda3 data
    ```

<br>

5. 編輯 /etc/fstab 文件，將原有的長標籤名稱替換為新的標籤名稱。

    ```bash
    sudo nano /etc/fstab
    ```

<br>

6. 編輯如下，其中掛載點尚未建立。

    ```bash
    proc            /proc           proc    defaults          0       0
    PARTUUID=343dcec1-01  /boot/firmware    vfat    defaults          0       2
    PARTUUID=343dcec1-02  /                 ext4    defaults,noatime  0       1
    PARTUUID=343dcec1-03  /media/sam6238/data   ext4   defaults,noatime  0       1
    ```

<br>

7. 建立新的掛載目錄。

    ```bash
    sudo mkdir -p /media/sam6238/data
    ```

<br>

8. 重新掛載所有文件系統。

    ```bash
    sudo mount -a
    ```

    _完成_

    ```bash
    mount: (hint) your fstab has been modified, but systemd still uses
       the old version; use 'systemctl daemon-reload' to reload.
    ```

<br>

9. 依指示執行指令，並輸入密碼。

    ```bash
    systemctl daemon-reload
    ```

    _輸出_

    ```bash
    sam6238@raspi-2024-ssd:~ $ systemctl daemon-reload
    ==== AUTHENTICATING FOR org.freedesktop.systemd1.reload-daemon ====
    Authentication is required to reload the systemd state.
    Authenticating as: ,,, (sam6238)
    Password: 
    ==== AUTHENTICATION COMPLETE ====
    ```

<br>

## 完成

1. 查詢。

    ```bash
    lsblk
    ```

    _輸出_

    ```bash
    NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
    sda      8:0    0 476.9G  0 disk 
    ├─sda1   8:1    0   512M  0 part /boot/firmware
    ├─sda2   8:2    0  97.7G  0 part /
    └─sda3   8:3    0 281.1G  0 part /media/sam6238/data
    ```

<br>

2. 查詢已掛載分區。

    ```bash
    df -h
    ```
    _輸出_
    ```bash
    Filesystem      Size  Used Avail Use% Mounted on
    udev            3.8G     0  3.8G   0% /dev
    tmpfs           805M  5.8M  800M   1% /run
    /dev/sda2        97G  4.3G   88G   5% /
    tmpfs           4.0G  288K  4.0G   1% /dev/shm
    tmpfs           5.0M   48K  5.0M   1% /run/lock
    /dev/sda1       510M   75M  436M  15% /boot/firmware
    tmpfs           805M  160K  805M   1% /run/user/1000
    /dev/sda3       276G   28K  262G   1% /media/sam6238/data
    ```

<br>

## 關於分區目錄

1. 如果在系統中建立了一個目錄，但未在 `/etc/fstab` 中指定掛載點，這個目錄仍然是可用的，但它會作為一個普通的空目錄存在於文件系統中，可以用來存放文件和資料夾，它不會自動掛載任何設備或分區，也就是說這個目錄並不會在開機時自動掛載任何設備或分區，必須手動掛載或者在需要時動態掛載。

<br>

2. 當更新 `/etc/fstab` 並運行 `sudo mount -a` 或者重啟系統後，新分區會才會掛載到這個目錄。

<br>

## 建立別名

_為自動生成的長路徑設置一個快捷命令來快速切換到該路徑_

<br>

1. 編輯 `~/.bashrc` 配置文件，是 `用戶級別` 的配置文件，用於配置 `Bash shell` 環境。

    ```bash
    nano ~/.bashrc
    ```

<br>

2. 在文件中添加以下指令創建一個別名，添加的位置並無規範，能集中便於查看或編輯即可。

    ```bash
    alias cddata='cd /media/sam6238/data'
    ```

3. 也可以建立一個環境變數來指向該路徑。

    ```bash
    export mydata='/media/sam6238/data'
    ```

<br>

4. 完成後要進行設置的刷新讓其生效。

    ```bash
    source ~/.bashrc
    ```

<br>

5. 完成以上步驟，透過以下兩個指令皆可將工作目錄切換到指定路徑中；特別注意，使用 `cd` 命令時，環境變數必須加上 `$` 才能正確引用，若僅執行 `cd mydata` 時， `mydata` 會被視為一個普通目錄名稱，而不是引用環境變數。

    ```bash
    # 透過環境參數切換目錄
    cd $mydata
    # 透過指令別名切換目錄
    cddata
    ```

<br>

## 建立符號鏈接

_不想使用 `$` 引用環境變數，也可透過符號鏈接來實現_

<br>

1. 在 `家目錄 (~)` 中創建一個名為 `mydata` 的 `符號鏈接`。

    ```bash
    ln -s /media/sam6238/data ~/mydata
    ```

    _建立後可進行查看_

    ![](images/img_140.png)

<br>

2. 這樣便可透過任何地方進行切換到家目錄中的鏈接符號中，但實際會指向該分區根目錄。

    ```bash
    cd ~/mydata
    ```

<br>

___

_END_
