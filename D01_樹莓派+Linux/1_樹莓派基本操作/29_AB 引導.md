# 設置 A/B 引導

_以下步驟將示範如何設置 A/B 引導機制並進行實際切換。特別注意，這裡僅測試引導分區，至於系統分區還是使用同一個。_

<br>

## 文件配置

1. 建立並編輯 `autoboot.txt` 文件，這個文件將用來配置引導分區及 A/B 引導機制。

    ```bash
    sudo nano /boot/firmware/autoboot.txt
    ```

<br>

2. 在 `autoboot.txt` 中添加以下內容：

    ```bash
    [all]
    # 啟用 A/B 引導機制
    tryboot_a_b=1
    # 默認從分區 1 引導
    boot_partition=1

    [tryboot]
    # 在 `tryboot` 模式下，從分區 2 引導
    boot_partition=2
    ```

<br>

## 查詢 `PARTUUID`

1. 指定設備進行查詢。

    ```bash
    sudo blkid /dev/sda1
    ```

    _輸出_

    ```bash
    /dev/sda1:
        UUID="bd85c692-1e30-4add-b35c-3ec9e4adc122" 
        BLOCK_SIZE="4096" 
        TYPE="ext4" 
        PARTUUID="0002192a-01"
    ```

<br>

## 配置 `cmdline.txt`

1. 編輯 `cmdline.txt` 文件以確保正確配置根文件系統。

    ```bash
    sudo nano /boot/firmware/cmdline.txt
    ```

<br>

2. 修改其中 `PARTUUID` 指向 `/dev/sda1`。

    ```bash
    console=serial0,115200 console=tty1 root=PARTUUID=0002192a-01 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles cfg80211.ieee80211_regdom=TW
    ```

<br>

3. 確認已掛載。

    ```bash
    df -h
    ```

<br>

4. 若是要完整同步當前系統文件到 USB 分區。

    ```bash
    sudo rsync -avx / /mnt/usb
    ```

<br>

5. 但若僅是進行 tryboot，只需將 `/boot/firmware` 下的必要引導文件複製到 `/mnt/usb`。

    ```bash
    sudo cp -r /boot/firmware/* /mnt/usb
    ```

<br>

## 切換到 `tryboot` 模式

1. 先卸載分區。

    ```bash
    sudo umount /mnt/usb
    ```

<br>

2. 確認已卸載。

    ```bash
    df -h
    ```

<br>

3. 使用以下命令重啟系統並進入 `tryboot` 模式。此模式將使用分區 2 作為引導分區。

    ```bash
    sudo reboot "0 tryboot"
    ```

<br>

## 驗證更新

_系統將從新的分區引導，驗證系統是否正常運行，並確保更新成功_

1. 確認 `tryboot` 模式是否激活：

    ```bash
    cat /proc/device-tree/chosen/bootloader/tryboot
    ```

<br>

2. 確認當前引導分區：

    ```bash
    cat /proc/device-tree/chosen/bootloader/partition
    ```

<br>

## 切換到新版本

1. 如果更新成功，編輯 `autoboot.txt` 文件，將默認引導分區設置為分區 `2`：

    ```bash
    sudo nano /boot/firmware/autoboot.txt
    ```

<br>

2. 修改 `autoboot.txt` 文件內容，保存並退出編輯器。

    ```plaintext
    [all]
    tryboot_a_b=1
    boot_partition=2

    [tryboot]
    boot_partition=1
    ```

<br>

## 重啟系統

1. 重新啟動系統，使更改生效。

    ```bash
    sudo reboot now
    ```

<br>

## 驗證切換結果

1. 系統應該從分區 `2` 引導。驗證當前引導分區。

    ```bash
    cat /proc/cmdline
    ```
保存並退出編輯器。
2. 確認 `root=PARTUUID` 是否為分區 2 的 UUID。

<br>

## 回到原本引導分區

1. 編輯 autoboot.txt 文件，將默認引導分區設置為分區 1。

    ```bash
    sudo nano /boot/firmware/autoboot.txt
    ```
保存並退出編輯器。
2. 修改 autoboot.txt 文件內容，保存並退出編輯器。

    ```bash
    [all]
    tryboot_a_b=1
    boot_partition=1

    [tryboot]
    boot_partition=2
    ```
保存並退出編輯器。
3. 重新啟動系統，使更改生效。

    ```bash
    sudo reboot now
    ```
保存並退出編輯器。
4. 驗證當前引導分區，確認是否回到分區 1。

    ```bash
    cat /proc/cmdline
    ```

<br>

___

_END_
