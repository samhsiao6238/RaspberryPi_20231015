# 連線免密碼

_`Windows` 或 `Mac` 相同_

<br>

## 建立本地設備的密鑰

1. 進入終端機。

    ![](images/img_701.png)

<br>

2. 輸入指令建立公私鑰。

    ```bash
    ssh-keygen
    ```

<br>

3. 一直都按下 `ENTER` 以預設值建立即可。

    ![](images/img_702.png)

<br>

## 查看

_完成後，開啟本地資料夾 `查看預設的公鑰`_

<br>

1. Windows 指令。

    ```bash
    type %userprofile%\.ssh\id_rsa.pub
    ```

<br>

2. MacOS 指令。

    ```bash
    cat ~/.ssh/id_rsa.pub
    ```

<br>

3. 複製下來，稍後步驟會需要複製貼上公鑰內容。

    ![](images/img_703.png)

<br>

## 設置遠端設備

_在樹莓派上建立公鑰檔案_

<br>

1. 連線樹梅派並在根目錄建立一個資料夾，使用參數 `-p` 可用於建立 `多層級` 的資料夾，如此可避免父目錄或中間目錄不存在而報錯。

    ```bash
    mkdir -p ~/.ssh
    ```

<br>

2. 在資料夾內建立一個檔案，貼上公鑰內容後，儲存 `control + o`、關閉檔案 `control + x`。

    ```bash
    nano ~/.ssh/authorized_keys
    ```

<br>

3. 可先透過 cat 查看，確認已經貼上。

    ```bash
    cat ~/.ssh/authorized_keys
    ```

<br>

4. 假如有多台設備都要連入，則一行寫一個公鑰。

    ![](images/img_705.png)

<br>

## 快速複製公鑰到遠端

1. 使用以下指令將公鑰複製到遠端伺服器，也就是樹莓派上，透過該指令複製時，無須先建立資料夾。

    ```bash
    ssh-copy-id <使用者名稱>@<遠端主機名稱或 IP>
    ```

<br>

2. 透過過程中顯示的訊息可知，這對公私鑰是由 `Ed25519` 算法所生成，這是一種相較於原本複製的 `RSA` 更安全的密鑰，生成後會要求輸入一次密碼來安裝公鑰到遠端。

    ![](images/img_155.png)

<br>

3. 可明確指定使用的私鑰文件。

    ```bash
    ssh -i ~/.ssh/<私鑰檔案名稱> <使用者名稱>@<遠端主機名稱或 IP>
    ```

    _如範例中自動生成的 `id_ed25519.pub`_

    ```bash
    ssh -i ~/.ssh/id_ed25519.pub <使用者名稱>@<遠端主機名稱或 IP>
    ```

<br>

## 修改設定檔案

_非絕對必要，有時候沒設定也可以正常運行_

<br>

1. 編輯 SSH 的設定檔。

    ```bash
    sudo nano /etc/ssh/sshd_config
    ```

<br>

2. 取消以下三行的註解。

    ```bash
    # 是否允許使用公鑰認證來驗證用戶身份
    PubkeyAuthentication yes
    
    # 指定存放已授權公鑰的文件路徑
    AuthorizedKeysFile .ssh/authorized_keys
    
    # 是否允許使用密碼進行身份驗證
    PasswordAuthentication yes
    ```

<br>

## 關於編輯檔案所需的權限

1. 修改 `~/.ssh` 目錄及其所有子目錄和檔案的權限，`700` 表示僅有 `擁有者` 具有 `讀、寫、執行` 的權限，而其他用戶沒有任何權限。

    ```bash
    sudo chmod -R 700 ~/.ssh
    ```

<br>

2. 更改 `~/.ssh/authorized_keys` 檔案的擁有者和所屬的組，與上一個指令呼應。

    ```bash
    sudo chown <帳戶>:<群組> ~/.ssh/authorized_keys
    ```
    如
    ```bash
    sudo chown sam6238:sam6238 ~/.ssh/authorized_keys
    ```

<br>

3. 重新啟動 SSH 服務。

    ```bash
    sudo service ssh restart
    ```

<br>

## 連線測試

_重新連線測試以上設置是否完成_
  
<br>

1. 退出連線。

    ```bash
    exit
    ```

<br>

2. 再次連線，不再提示輸入密碼， VSCODE 的 SSH 也一樣。

    ![](images/img_707.png)

<br>

3. 若要查看 SSH 日誌。

    ```bash
    sudo journalctl -u ssh
    ```

<br>

4. 使用 `-v` 參數進行連線查看更多連線資訊，也稱為 `詳細模式（verbose mode）`。

    ```bash
    ssh -v <帳號>@<主機名稱>
    ```
    如
    ```bash
    ssh -v sam6238@raspi-2023-09
    ```

<br>

5. 特別說明，當使用參數 `-v`、`-vv`、`-vvv` 等 `詳細模式（verbose mode）` 連線時，也代表會更詳細地檢查連線的程序，這可能會導致密鑰設置失效，並需要輸入密碼的情況，這是因為一般連線時並未進行詳細的檢查，也是一種相對寬鬆的連線安全管控，這時需要更進一步排查造成這個問題的原因。

<br>

## 錯誤排除

_嘗試排除  `詳細模式（verbose mode）` 時的密鑰失效問題 _

<br>

1. 對於指定遠端主機名稱或 IP 清除本地連線紀錄。

    ```bash
    ssh-keygen -R <主機名稱或 IP>
    ```

<br>

2. 重啟 SSH 服務

    ```bash
    sudo service ssh restart
    ```

<br>

3. 修改 .ssh 目錄和 authorized_keys 文件的擁有者及權限。

    ```bash
    sudo chown -R <使用者帳戶>:<使用者同名群組> ~/.ssh
    sudo chmod 700 ~/.ssh
    sudo chmod 600 ~/.ssh/authorized_keys
    ```

4. 檢查 `.ssh` 目錄的權限和擁有者。

    ```bash
    ls -ld ~/.ssh
    ```

<br>

5. 檢查 `authorized_keys` 文件的權限和擁有者。

    ```bash
    ls -l ~/.ssh/authorized_keys
    ```

<br>

## 補充說明權限問題

1. 雖未在 OpenSSH 官方說明文件中看到具體對於文件或資料夾權限的說明，但依據 [Ubuntu 官方文件](https://help.ubuntu.com/community/SSH/OpenSSH/Keys) 指出，SSH 在連線時會嚴格檢查權限設定，要求 .ssh 目錄必須由用戶自己擁有，並且權限設置為 700；另外，authorized_keys 文件必須由用戶自己擁有，並且權限設置為 600。目錄或文件由 root 擁有時，即便使用者屬於 root 群組也可能會導致權限問題，尤其是在 SSH 的服務中，在某些嚴謹的系統上，若權限不符合這樣的規範，SSH 將拒絕進行文件認證。

    ![](images/img_156.png)

<br>

___

_END_